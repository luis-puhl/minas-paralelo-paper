% !TeX root = ./00.ppgcc-2020.tex

% \chapter{Implementação}\label{cha:implementacao}

% % procedimento experimental previamente definido de ambos, \mfog e da
% % implementação original do algoritmo MINAS, e comparadas.

% \input{52.preliminares.tex}
% \input{53.mpi.tex}

\chapter{Experimentos e Resultados}\label{cha:results}

Este capítulo apresenta o ambiente experimental e os resultados obtidos dos
experimentos, discutindo as métricas de classificação e escalabilidade.

\input{51.ambiente.tex}
% \input{54.experimentos.tex}

% \FloatBarrier
\section{Métricas e Visualizações}
\label{sec:experiments}
% acho que convém explicar as demais tabelas de resultados...

\newcommand{\serial}{\textit{Serial}\xspace}

Seguindo as especificações de ambiente da Seção \ref{sec:ambiente}, cada
experimento consiste na execução de um dos programas (\refminas, \serial e
\mfog) com variação do parâmetro de paralelismo, fornecendo um modelo inicial e
\dataset de teste como fluxo de entrada e capturando o fluxo de saída para e
extração das métricas estabelecidas na Seção \ref{sec:avaliacao}.
Destes experimentos os seguintes resultados são apresentados.

\subsection{Validação do algoritmo}

Para validar a biblioteca de funções que implementa o algoritmo \minas no \mfog,
uma versão do Algoritmo \ref{alg:minas-main} foi construída, nomeada \serial,
não tem classificadores paralelos ou detecção de novidade assíncrona, aspectos
que caracterizam o \mfog.
A versão \serial passou pelo mesmo processo experimental e extração de métricas,
juntamente com a implementação de referência do algoritmo \minas (\refminas).

A Tabela \ref{tab:java-matrix} mostra a matriz de confusão no instante final do
fluxo de saída de \refminas.
Nesta matriz, o rótulo ``desconhecido'' é o caractere ``$-$'' e o valor de
associação e verdadeiro-positivo estão atrelados à coluna de cada rótulo, no
demais a matriz segue os atributos definidos na Seção \ref{sec:avaliacao}.
Esta matriz é comparada com a matriz de confusão do mesmo instante do fluxo de
saída de \serial, na Tabela \ref{tab:libc-matrix}.

\begin{table}[hbt]%{\linewidth}
  {\footnotesize
  % \setlength\tabcolsep{0.5em}
  \begin{center}
  \caption{Experimento \refminas (implementação referência), Matriz de confusão do \dataset \emph{Kyoto} Dez. 2015.}
  \label{tab:java-matrix}
  \begin{tabular}{l *{14}{|r} }
    Rótulos   &     - &       N &    1 &    2 &    3 &  4 &   5 &    6 &    7 &     8 &    9 &    10 &   11 &  12 \\\hline
    Classes  &       &         &      &      &      &    &     &      &      &       &      &       &      &     \\\hline
    \hline
    A        &  3774 &  438750 &  123 &  145 &  368 &  8 &  52 &  165 &    1 &  1046 &  161 &  2489 &   71 &  26 \\\hline
    N        &  8206 &  193030 &    0 &   79 &   44 &  0 &   0 &    0 &  229 &   181 &  154 &  4066 &  289 &   0 \\\hline
    \hline
    Associação &     - &       N &    A &    A &    A &  A &   A &    A &    N &     A &    A &     N &    N &   A \\\hline
    Hits ($tp$)     &     0 &  193030 &  123 &  145 &  368 &  8 &  52 &  165 &  229 &  1046 &  161 &  4066 &  289 &  26 
  \end{tabular}
\end{center}
}
\end{table}

Comparando as duas matrizes, a primeira diferença aparante é o índice do
primeiro rótulo novidade ($0$ ao invés de $1$) mas isso se deve apenas à decisão
arbitrária.
A primeira diferença notável que influi nas métricas de qualidade é a falta de
um rótulo novidade, $12$ rótulos em \refminas e $11$ em \serial,
seguido do número de exemplos desconhecidos, $28\,567$ em \serial e $11\,980$ em
\refminas e, o montante de exemplos incluídos nos rótulos novidade, muito menor
em \serial.

\begin{table}[hbt]%{\linewidth}
  % {\small
  % \setlength\tabcolsep{0.5em}
  \begin{center}
  \caption{Experimento \serial, Matriz de confusão do \dataset \emph{Kyoto} Dez. 2015.}
  \label{tab:libc-matrix}
  \begin{tabular}{l|r|r|r|r|r|r|r|r|r|r|r}
    Rótulos &      - &       N &   0 &    1 &    2 &   4 &   5 &  6 &   7 &   8 &  10 \\\hline
    Classes  &        &         &     &      &      &     &     &    &     &     &     \\\hline
    \hline
    A        &  16086 &  429765 &  94 &  995 &  104 &   0 &  23 &  3 &  29 &  46 &  34 \\\hline
    N        &  12481 &  193642 &   3 &   94 &    0 &  47 &   0 &  0 &   0 &  11 &   0 \\\hline
    \hline
    Associação &      - &       N &   A &    A &    A &   N &   A &  A &   A &   A &   A \\\hline
    Hits ($tp$)     &      0 &  193642 &  94 &  995 &  104 &  47 &  23 &  3 &  29 &  46 &  34 
  \end{tabular}
  \end{center}
  % }
\end{table}

Estas três diferenças são atribuídas à divergência entre as definições de raio
discutidas na Seção \ref{sec:minas-og}, Equações \ref{eq:raio_max} e
\ref{eq:raio_paper}.
Estas divergência apesar de inicialmente pequena, muda muito o comportamento do
passo de classificação, resultando em um conjunto diferente de desconhecidos e
por fim, mudando muito o resultado da detecção de novidades.
Adicionalmente, como o parâmetro $f_{raio}$ (\texttt{radiusF}) não existe na
versão com raio definido como distância máxima (Eq. \ref{eq:raio_max}), este
parâmetro foi escolhido experimentalmente observando os resultado durante a
implementação.

Além das matrizes de confusão que dão uma visão detalhada porém, somente sobre o
último instante do fluxo, pode-se comparar a visualizações de fluxo onde as
métricas de qualidade são apresentadas para todo o fluxo.
As Figuras \ref{fig:validation-java} e \ref{fig:validation-serial} ilustram os
fluxos de saída de \refminas e \serial respectivamente.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.75\linewidth]{experiments/revised-java-log.png}
  \caption{Experimento \refminas (implementação referência), visualização de fluxo do \dataset \emph{Kyoto} Dez. 2015.}
  \label{fig:validation-java}
\end{figure}

As Figuras \ref{fig:validation-java} e \ref{fig:validation-serial} reforçam a
observação anterior de que mais rótulos novidade (linhas tracejadas verticais
com rótulo no topo) foram encontrados por \refminas do que as encontradas por
\serial.
Outro aspecto com relação à rótulos novidade, em \refminas eles surgem mais
``cedo'' no fluxo (primeira marcação muito antes de $x = 100\,k$).

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.75\linewidth]{experiments/online-nd-log.png}
  \caption{Experimento \serial, visualização de fluxo do \dataset \emph{Kyoto} Dez. 2015.}
  \label{fig:validation-serial}
\end{figure}

O gráfico de visualização do fluxo tem no eixo horizontal (x, domínio) o índice
do exemplo $x$ e o eixo vertical (y, imagem) mostra o valor das métricas
calculadas até aquele índice de exemplo $x$ no fluxo de saída capturado.
As linhas horizontais na visualização de fluxo mostram o progresso das métricas
de qualidade de classificação durante o fluxo e, ao final na esquerda, o valor
impresso junto e de mesma cor à linha é o valor final de cada métrica.
As métricas são: 
em laranja a taxa de desconhecidos (\texttt{unk}),
em verde a acurácia (\texttt{hit}) e
em azul o erro (\texttt{err}).
Estas métricas podem ser arranjadas em uma tripla-sumário
(\texttt{unk}, \texttt{hit}, \texttt{err})
com os valores em pontos percentuais para fácil comparação.

% Por último, o gráfico de visualização do fluxo mostra as métricas de qualidade
% resumida (\ emph {Acessos}, \ emph {Desconhecidos}, \ emph {Erros}) computada
% para cada exemplo no fluxo de saída capturado. Este resumo é calculado para cada
% exemplo, mas usa a linha \ emph {Atribuída} calculada anteriormente para avaliar
% \ emph {Acertos}; as outras medidas são derivadas conforme descrito antes. 

% Lastly, the stream visualization chart shows the summary quality measurement
% (\emph{Hits}, \emph{Unknowns}, \emph{Misses})
% computed for each example in the captured output stream.
% This summary is computed for each example, but it uses the \emph{Assigned} row
% computed previously to evaluate \emph{Hits}; the other measurements are derived as
% described before.
% The Horizontal axis (x, domain) plots the index of the example and the
% vertical axis (y, image) shows the measurement computed until that example index on the captured
% output stream.


Em conclusão das métricas de qualidade de classificação, \refminas e \serial
não são idênticos pois não implementam a mesma definição, porém são semelhantes
em seus resultados.
Enquanto \refminas tem tripla-sumário 
($01.8\%,\: 30.6\%,\: 67.6\%$), \serial tem
mais desconhecidos, menor acurácia e menor erro com 
($04.4\%,\: 29.8\%,\: 65.8\%$).

Para as métricas de escalabilidade, \refminas e \serial servem somente como base
para os próximos experimentos onde o paralelismo passa a ser utilizado.
Uma última nota quanto ao tempo de execução, mesmo não sendo paralelo, as
otimizações de memória, redução do uso de \emph{strings} e outras cópias e
condição de para do algoritmo \emph{K-Means}, reduziram o tempo utilizado por
\refminas de $2\;772s$ ($917s$ \emph{offline} e $1\;845s$ \emph{online}) para
$287s$ ($194s$ \emph{offline} e $93s$ \emph{online}) em \serial.

\subsection{Paralelismo e Distribuição}

% For the measurements summary table, six measurements from two sources are displayed. Three
  % measures \emph{Hits}, \emph{Unknowns} and \emph{Misses} represented as ratio of
  % the captured output stream, extracted from the evaluation python program,
  % computed as follows:
  % \emph{Hits} (true positive rate) is the sum of the \emph{Hits} row in the
  % extended confusion matrix;
  % \emph{Unknowns} is the count of examples in the captured output stream marked
  % with the \emph{unknown} label (\emph{``-''});
  % \emph{Misses} is the count of all examples in the captured output stream marked
  % with a label distinct from the \emph{Assigned} original class and are not marked
  % as unknown.

  % Furthermore in the measurement summary table, \emph{Time}, \emph{System} and \emph{Elapsed}
  % represented in seconds, are extracted from \emph{GNU Time 1.9}.
  % \emph{Time} is the amount of CPU seconds expended in user-mode
  % (indicates time used doing CPU intensive computing, e.g., math);
  % \emph{System} is the amount of CPU seconds expended in kernel-mode
  % (for our case, it indicates time doing input or output);
  % \emph{Elapsed} is the real-world (wall clock) elapsed time and
  % indicates how long the program took to complete.
  % The lower the times, the better.
  % Our four main experiments are shown in Tab. \ref{tab:exper-summary}.

  % Lastly, the stream visualization chart shows the summary quality measurement
  % (\emph{Hits}, \emph{Unknowns}, \emph{Misses})
  % computed for each example in the captured output stream.
  % This summary is computed for each example, but it uses the \emph{Assigned} row
  % computed previously to evaluate \emph{Hits}; the other measurements are derived as
  % described before.
  % The Horizontal axis (x, domain) plots the index of the example and the
  % vertical axis (y, image) shows the measurement computed until that example index on the captured
  % output stream.

  % Adding to the stream visualization chart, novelty label markers are represented
  % as vertical lines indicating \emph{when} in the captured output stream a new
  % label first appeared.
  % Some of the novelty label markers include the label itself ($l \in \mathbb{N}$)
  % for reference (showing every label would turn this feature unreadable due
  % to overlapping).
  % Figure \ref{fig:visualization} shows complete stream visualization charts.

  % \begin{table*}[htb]
  % \caption{Confusion Matrixes and Qualitative measurements}
  % \label{tab:confusion-matrixes-ref-serial}

% \vspace{3ex}

\newcommand{\single}{\textit{Paralelo}\xspace}
\newcommand{\multi}{\textit{Distribuído}\xspace}

Seguindo as comparações, para avaliar a escalabilidade do sistema os
experimentos com o \mfog completo em duas configurações, um nó (\single) e três
nós (\multi), foram realizadas com o mesmo roteiro.
As Tabelas \ref{tab:single-matrix} e \ref{tab:multi-matrix} mostram as matrizes
de confusão dos experimentos \single e \multi respectivamente.

\begin{table}[hbt]
  \centering
  % \setlength\tabcolsep{0.5em}
  \caption{Experimento \mfog \single com 4 núcleos, Matriz de confusão do \dataset \emph{Kyoto} Dez. 2015.}
  \label{tab:single-matrix}
  \begin{tabular}{l|r|r|r|r|r|r|r}
    Rótulos &      - &       N &    0 &    1 &   2 &  3 &  4 \\\hline
    Classes  &        &         &      &      &     &    &    \\\hline
    \hline
    A        &  12282 &  433797 &  147 &  952 &   0 &  0 &  1 \\\hline
    N        &   3088 &  203019 &   40 &   99 &  27 &  5 &  0 \\\hline
    \hline
    Associação &      - &       N &    A &    A &   N &  N &  A \\\hline
    Hits ($tp$)     &      0 &  203019 &  147 &  952 &  27 &  5 &  1 
  \end{tabular}
\end{table}

Comparando as matrizes dos experimentos \serial e \single, já observa-se os
efeitos do paralelismo de classificadores e, mais importante, a execução
assíncrona da tarefa de detecção de novidade.
O impacto principal é a redução no número de rótulos novidade de $11$ para $5$.
Comparando a visualização de fluxo, Figuras \ref{fig:validation-serial} e
\ref{fig:single-flow}, observa-se também que a aparição do primeiro padrão
novidade acontece mais ``tarde'', enquanto em \serial o rótulo novidade ``1'' é
observado em $x = 94\;155$, em \single o mesmo rótulo é observado em $x =
172\;917$.

A tripla-sumário do experimento \single é ($02.4\%,\: 31.2\%,\: 66.4\%$),
mostrando uma melhor em comparação à ($04.4\%,\: 29.8\%,\: 65.8\%$) do
experimento \serial.

Esse comportamento é devido à detecção de novidade assíncrona pois, enquanto
essa tarefa é executada os classificadores continuam utilizando o modelo antigo.
Além disso, como já foi elencado na Seção \ref{sec:polices} item
\ref{reclassification}, os exemplos utilizados para formar o novo \mcluster
com rótulo novidade não são colocados no fluxo de saída.
Estas duas características do \mfog acarretam em um atraso significante entre a
aparição de um padrão no fluxo de entrada e a aparição do rótulo correspondente
no fluxo de saída.
Em outras palavras, o fluxo avança com o modelo antigo e, mesmo após atualizado,
só gera uma saída com o rótulo novo quando (e se) o padrão aparece novamente.
Este é um resultado muito importante para compreender os problemas relacionados
à distribuição de um algoritmo deste gênero.

\begin{table}[hbt]
  \centering
  % \setlength\tabcolsep{0.5em}
  \caption{Experimento \mfog \multi com 3 nós de 4 núcleos, Matriz de confusão do \dataset \emph{Kyoto} Dez. 2015.}
  \label{tab:multi-matrix}
  \begin{tabular}{l|r|r|r|r|r|r|r}
    Rótulos   &      - &       N &    0 &    1 &    2 &    3 &  4 \\\hline
    Classes   &        &         &      &      &      &      &    \\\hline
    \hline
    A      &  12378 &  433631 &  117 &  886 &    0 &  162 &  5 \\\hline
    N      &   3121 &  202916 &   40 &   96 &  105 &    0 &  0 \\\hline
    \hline
    Associação   &      - &       N &    A &    A &    N &    A &  A \\\hline
    Hits ($tp$)   &      0 &  202916 &  117 &  886 &  105 &  162 &  5 
  \end{tabular}
\end{table}

Avançando para o último experimento, a matriz de confusão do experimento \multi
(Tab. \ref{tab:multi-matrix}) mostra pouca diferença quando comparado à \single
com o número de desconhecidos sofrendo a maior variação.
O mesmo é observado quando compara-se a visualização de fluxo, Figuras
\ref{fig:single-flow} e \ref{fig:multi-flow}, pouca divergência.
Até mesmo a tripla-sumário ($02.4\%,\: 31.2\%,\: 66.4\%$) é idêntica.

Isto reforça a ideia de que o maior impacto na métricas de qualidade de
classificação é a mudança de detecção de novidade assíncrona, pois mesmo com o
triplo de instancias classificadoras, as métricas continuam idênticas.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.75\linewidth]{experiments/tmi-base-log.png}
  \caption{Experimento \mfog \single com 4 núcleos, visualização de fluxo do \dataset \emph{Kyoto} Dez. 2015.}
  \label{fig:single-flow}
\end{figure}


\begin{figure}[htb]
  \centering
  \includegraphics[width=0.75\linewidth]{experiments/tmi-n12-log.png}
  \caption{Experimento \mfog \multi com 3 nós de 4 núcleos, visualização de fluxo do \dataset \emph{Kyoto} Dez. 2015.}
  \label{fig:multi-flow}
\end{figure}

\section{Conclusão}
\label{sec:exp-conclusao}

Os quatro experimentos principais são mostrados na Tabela
\ref{tab:exper-summary}.

Além disso, na tabela de sumário das métricas, \emph{Tempo}, \emph{Sistema} e
\emph{Decorrido} representados em segundos, são extraídos de \emph{GNU Time
1.9}.
\emph{Tempo} é a quantidade de segundos de CPU gastos no modo de usuário
(indica o tempo usado em computação intensiva, por exemplo cálculos matemáticos);
\emph{Sistema} é a quantidade de segundos de CPU gastos no modo \emph{kernel} (para
nosso caso, indica o tempo de entrada ou saída);
\emph{Decorrido} é o tempo decorrido do mundo real (relógio de parede) e indica
quanto tempo o programa levou para ser concluído.
Quanto mais baixos os tempos, melhor.

\newcommand{\mr}[1]{\multirow{2}{*}{#1}}
\begin{table}[hbt]
  \centering
% \setlength\tabcolsep{0.35em}
  \caption{Sumário das métricas.}
  \label{tab:exper-summary}
  \begin{tabular}{l|r|r|r|r|r}
  Experimento     & \refminas (a) & Offline       & \serial (b)     & Único nó (c)   & Três nós (d)  \\
  Métrica           &               &               &                 &                 &   \\\hline
  \mr{\texttt{hit}}       & $\ 199708\ $   &               & $\ 195017\ $    & $\ 204151\ $    & $\ 204191\ $    \\
                  & $\ 0.305618\ $ &               & $\ 0.298438\ $  & $\ 0.312416\ $  & $\ 0.312478\ $  \\
  \hline
  \mr{\texttt{err}}     & $\ 441769\ $   &               & $\ 429873\ $    & $\ 433936\ $    & $\ 433767\ $    \\
                  & $\ 0.676049\ $ &               & $\ 0.657843\ $  & $\ 0.664061\ $  & $\ 0.663802\ $  \\
  \hline
  \mr{\texttt{unk}}   & $\ 11980\ $    &               & $\ 28567\ $     & $\ 15370\ $     & $\ 15499\ $     \\
                  & $\ 0.018333\ $ &               & $\ 0.043717\ $  & $\ 0.023521\ $  & $\ 0.023718\ $  \\
  \hline
  Tempo            & $\ 2761.83\ $  & $\ 194.12\ $  & $\ 80.79000\ $  & $\ 522.1000\ $  & $\ 207.1400\ $  \\\hline
  Sistema          & $\ 7.15\ $     & $\  0.075\ $  & $\ 11.51000\ $  & $\  47.7700\ $  & $\ 157.6100\ $  \\\hline
  Decorrido         & $\ 2772.07\ $  & $\ 194.27\ $  & $\ 93.03000\ $  & $\ 145.0400\ $  & $\  95.3800\ $  
  \end{tabular}
\end{table}

